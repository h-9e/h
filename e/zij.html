<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y个人财务管理</title>
    <link rel="stylesheet" href="css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --gray-color: #94a3b8;
            --border-radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            
            /* 玻璃拟态效果 */
            background: rgba(67, 97, 238, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            
            /* 渐变叠加 */
            background-image: 
                linear-gradient(135deg, 
                    rgba(67, 97, 238, 0.8) 0%, 
                    rgba(58, 12, 163, 0.8) 100%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
		
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: white;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .income .stat-icon {
            background-color: rgba(74, 222, 128, 0.1);
            color: var(--success-color);
        }

        .expense .stat-icon {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .balance .stat-icon {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }

        .stat-info h3 {
            font-size: 1rem;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .date-range-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 10px;
        }

        .date-range-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-range-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .date-range-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .date-range-label {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .date-range-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }

        @media (max-width: 992px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #22c55e;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-small {
            font-size: 0.9rem;
        }

        .transactions-container {
            min-height: 600px;
			background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background-color: var(--light-color);
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            padding-left: 45px;
            width: 100%;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .search-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .search-tag button {
            background: none;
            border: none;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .transactions-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .transaction-info p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .income-text {
            color: var(--success-color);
        }

        .expense-text {
            color: var(--danger-color);
        }

        .transaction-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 5px;
        }

        .category-food {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .category-transport {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .category-entertainment {
            background-color: rgba(168, 85, 247, 0.1);
            color: #a855f7;
        }

        .category-shopping {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .category-bills {
            background-color: rgba(6, 182, 212, 0.1);
            color: #06b6d4;
        }

        .category-income {
            background-color: rgba(74, 222, 128, 0.1);
            color: var(--success-color);
        }

        .category-other {
            background-color: rgba(148, 163, 184, 0.1);
            color: var(--gray-color);
        }

        .transaction-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            user-select: none;
        }

        .chart-title.clickable {
            cursor: pointer;
            transition: var(--transition);
        }

        .chart-title.clickable:hover {
            color: var(--primary-color);
        }

        .chart-title .toggle-icon {
            transition: transform 0.3s ease;
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-left: 10px;
        }

        .chart-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .chart-wrapper {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .chart-container.collapsed .chart-wrapper {
            display: none;
        }

        .chart-container.collapsed .chart-legend {
            display: none;
        }

        .chart-container.collapsed {
            padding-bottom: 10px;
        }

        .chart-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .delete-btn:hover {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
        }

        .edit-btn {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .edit-btn:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-info {
                align-items: flex-start;
                width: 100%;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .date-range-form {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .date-range-actions {
                margin-left: 0;
                width: 100%;
            }
            
            .filters {
                justify-content: center;
            }
            
            .transaction-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .form-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .search-actions {
                flex-wrap: wrap;
            }
            
            .chart-legend {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* 加载指示器 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--dark-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: var(--danger-color);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .import-instructions {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .import-instructions h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 15px;
            background-color: var(--light-color);
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .file-input-label:hover {
            border-color: var(--primary-color);
            background-color: #f1f5f9;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        #cancel-edit {
            display: none;
        }
        
        .date-range-summary {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-range-summary h3 {
            font-size: 1rem;
            color: var(--dark-color);
        }
        
        .date-range-summary p {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .date-range-buttons {
            display: flex;
            gap: 5px;
        }
        
        .quick-date-btn {
            padding: 6px 12px;
            background-color: var(--light-color);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        
        .quick-date-btn:hover {
            background-color: #e2e8f0;
        }
        
        .quick-date-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .search-results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: #f8fafc;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .clear-search-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }
		
		/* 添加删除确认模态框的特定样式 */
		.delete-details {
			text-align: left;
			border-left: 3px solid var(--danger-color);
			padding-left: 10px;
		}

		.delete-details div {
			padding: 3px 0;
		}

		/* 模态框动画效果 */
		.modal-content {
			animation: modalFadeIn 0.3s ease-out;
		}

		@keyframes modalFadeIn {
			from {
				opacity: 0;
				transform: translateY(-20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* 危险按钮悬停效果 */
		.btn-danger {
			transition: all 0.3s ease;
		}

		.btn-danger:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
		}
		
		/* 在现有的 CSS 中添加以下样式 */
		.inline-label-select {
			display: flex;
			align-items: center;
			gap: 15px;
		}

		.inline-label-select label {
			margin-bottom: 0;
			min-width: 80px; /* 给 label 设置一个最小宽度，确保对齐 */
			flex-shrink: 0; /* 防止 label 被压缩 */
		}

		.inline-label-select select {
			flex-grow: 1; /* 让 select 占据剩余空间 */
		}
		
		/* 在现有的 CSS 中添加以下样式 */
		.form-row {
			display: flex;
			align-items: center;
			gap: 15px;
			margin-bottom: 0; /* 覆盖原有的 margin-bottom */
		}

		.form-row label {
			margin-bottom: 0;
			min-width: 80px;
			flex-shrink: 0;
		}

		.form-row select,
		.form-row input {
			flex: 1;
		}

		/* 响应式调整：在小屏幕上恢复垂直布局 */
		@media (max-width: 768px) {
			.form-row {
				flex-direction: column;
				align-items: flex-start;
				gap: 8px;
			}
			
			.form-row label {
				min-width: auto;
				margin-bottom: 5px;
			}
			
			.form-row select,
			.form-row input {
				width: 100%;
			}
		}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <div>
                    <h1>2026财务</h1>
                    <h3 id="current-date">正在加载...</h3>
                </div>
            </div>
            <div class="header-info">
                <div class="header-actions">
            
                    <button class="btn btn-success btn-small" id="add-record-btn">
                        <i class="fas fa-plus"></i> 添加
                    </button>
                    <button class="btn btn-secondary btn-small" id="export-btn">
                        <i class="fas fa-download"></i> 导出数据
                    </button>
                    <button class="btn btn-secondary btn-small" id="import-btn">
                        <i class="fas fa-upload"></i> 导入数据
                    </button>
                </div>
            </div>
        </header>

        <div class="date-range-container">
            <div class="date-range-form">
				<div class="date-range-group">
                    <input type="date" id="start-date" name="start-date">
                </div>
				<div class="date-range-title">~</div>
                <div class="date-range-group">
                    <input type="date" id="end-date" name="end-date">
                </div>
                <div class="date-range-buttons">
                    <button class="quick-date-btn" data-range="all">全部</button>
          
                    <button class="quick-date-btn" data-range="prev-month">上月</button>
                    <button class="quick-date-btn" data-range="today">今天</button>
                    <button class="quick-date-btn" data-range="week">本周</button>
                    <button class="quick-date-btn active" data-range="month">本月</button>
                    <button class="quick-date-btn" data-range="next-month">下月</button>
                    <button class="quick-date-btn" data-range="year">今年</button>
                </div>
                <div class="date-range-actions">
                    <button class="btn btn-primary" id="apply-date-range">
                        <i class="fas fa-chart-bar"></i> 查询统计
                    </button>
                    <button class="btn btn-secondary" id="reset-date-range">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
            </div>
            <div class="date-range-summary" id="date-range-summary" style="display: none;">
                <h3 id="date-range-title">日期区间统计结果</h3>
                <p id="date-range-total">总收入: ¥0.00 | 总支出: ¥0.00 | 现有: ¥0.00</p>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card income">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-info">
                    <h3>总收入</h3>
                    <p id="total-income">¥0.00</p>
                </div>
            </div>
            <div class="stat-card expense">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-info">
                    <h3>总支出</h3>
                    <p id="total-expense">¥0.00</p>
                </div>
            </div>
            <div class="stat-card balance">
                <div class="stat-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="stat-info">
                    <h3>当前余额</h3>
                    <p id="current-balance">¥0.00</p>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="left-column">

                <div class="chart-container collapsed" id="income-chart-container">
                    <div class="chart-title clickable collapsed" id="income-chart-toggle">
                        <h2 class="section-title">
                            <i class="fas fa-chart-pie"></i> 收入分类统计
                            <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                        </h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="incomeChart"></canvas>
                        <div id="income-chart-placeholder" class="empty-state" style="display: none;">
                            <i class="fas fa-chart-pie"></i>
                            <h3>暂无收入数据</h3>
                            <p>添加收入记录以查看分类统计</p>
                        </div>
                    </div>
                    <div class="chart-legend" id="income-chart-legend">
                 
                    </div>
                </div>
                
    
                <div class="chart-container" id="expense-chart-container">
                    <div class="chart-title clickable" id="expense-chart-toggle">
                        <h2 class="section-title">
                            <i class="fas fa-chart-pie"></i> 支出分类统计
                            <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                        </h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="expenseChart"></canvas>
                        <div id="expense-chart-placeholder" class="empty-state" style="display: none;">
                            <i class="fas fa-chart-pie"></i>
                            <h3>暂无支出数据</h3>
                            <p>添加支出记录以查看分类统计</p>
                        </div>
                    </div>
                    <div class="chart-legend" id="expense-chart-legend">
       
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="transactions-container">
                    <div class="section-title">
                        <i class="fas fa-list"></i> 交易记录
                    </div>
                    
                    <div class="filters-container">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" placeholder="搜索交易描述、分类或金额...">
                        </div>
                        
                        <div class="search-actions" id="search-actions" style="display: none;">
                            <!-- 搜索标签将动态生成 -->
                        </div>
                        
                        <div id="search-results-info" class="search-results-info" style="display: none;">
                            <span id="search-results-text">找到 <span id="search-results-count">0</span> 条相关记录</span>
                            <button class="clear-search-btn" id="clear-search-btn">
                                <i class="fas fa-times"></i> 清除搜索
                            </button>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-btn active" data-filter="all">全部</div>
                            <div class="filter-btn" data-filter="income">收入</div>
                            <div class="filter-btn" data-filter="expense">支出</div>
                            <div class="filter-btn" data-filter="food">餐饮</div>
                            <div class="filter-btn" data-filter="transport">交通</div>
                            <div class="filter-btn" data-filter="entertainment">娱乐</div>
							<div class="filter-btn" data-filter="shopping">购物</div>
							<div class="filter-btn" data-filter="bills">生活</div>
							<div class="filter-btn" data-filter="other">另类</div>
                        </div>
                    </div>
                    
                    <div class="transactions-list" id="transactions-list">
                        <div class="empty-state">
                            <div class="loading"></div>
                            <p>正在加载数据...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>资金明细 &copy; <span id="current-year">2026</span> | 使用IndexedDB本地存储</p>
        </footer>
    </div>

    <!-- 修改2：新增交易记录模态框 -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> <span id="modal-form-title">添加交易记录</span></h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="transaction-form">
                <input type="hidden" id="edit-id" value="">
                <div class="form-group">
                    <div class="form-row">
                        <label for="type">交易类型</label>
                        <select id="type" name="type" required>
                            <option value="income">收入</option>
                            <option value="expense" selected>支出</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="category">分类</label>
                        <select id="category" name="category" required>
                            <option value="food" selected>餐饮食品</option>
                            <option value="transport">交通出行</option>
                            <option value="entertainment">娱乐休闲</option>
                            <option value="shopping">购物消费</option>
                            <option value="bills">生活账单</option>
                            <option value="salary">工资收入</option>
                            <option value="other">另类</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="amount">金额 (¥)</label>
                        <input type="number" id="amount" name="amount" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="description">描述</label>
                        <input type="text" id="description" name="description" placeholder="交易描述（可选）">
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="date">日期</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-save"></i> 保存记录
                    </button>
                    <button type="button" class="btn btn-secondary close-modal">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-upload"></i> 导入数据</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="import-instructions">
                <h3>导入说明：</h3>
                <p>1. 请选择之前从本系统导出的JSON文件</p>
                <p>2. 导入的数据将添加到现有数据中，不会删除现有数据</p>
                <p>3. 如果导入的数据中包含与现有记录相同的ID，将会跳过该记录</p>
            </div>
            <div class="form-group">
                <div class="file-input-wrapper">
                    <input type="file" id="import-file" accept=".json">
                    <label for="import-file" class="file-input-label">
                        <i class="fas fa-file-upload" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>点击选择文件或拖放文件到这里</p>
                        <p style="font-size: 0.8rem; color: var(--gray-color);">支持JSON格式文件</p>
                    </label>
                </div>
                <div class="file-name" id="file-name">未选择文件</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="confirm-import">
                    <i class="fas fa-upload"></i> 开始导入
                </button>
                <button class="btn btn-secondary close-modal">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
	
	
	<div id="delete-confirm-modal" class="modal">
		<div class="modal-content" style="max-width: 400px;">
			<div class="modal-header">
				<h2><i class="fas fa-trash-alt"></i> 确认删除</h2>
				<button class="close-modal">&times;</button>
			</div>
			<div class="form-group" style="text-align: center; padding: 20px 0;">
				<i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 15px;"></i>
				<p style="font-size: 1.1rem; line-height: 1.5;">确定要删除这条交易记录吗？</p>
				<p style="color: var(--gray-color); font-size: 0.9rem; margin-top: 10px;">此操作无法撤销，记录将被永久删除。</p>
			</div>
			<div class="modal-actions" style="justify-content: center;">
				<button class="btn btn-danger" id="confirm-delete">
					<i class="fas fa-trash"></i> 确认删除
				</button>
				<button class="btn btn-secondary close-modal">
					<i class="fas fa-times"></i> 取消
				</button>
			</div>
		</div>
	</div>


    <script>
        // 动态加载Chart.js库
        function loadChartJS() {
            return new Promise((resolve, reject) => {
                // 检查是否已经加载
                if (typeof Chart !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'js/chart.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
    
    <script>
        // 设置当前日期显示（立即执行，不等待DOMContentLoaded）
        const now = new Date();
        const currentDateElement = document.getElementById('current-date');
        if (currentDateElement) {
            currentDateElement.textContent = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
        }
        
        // 设置当前年份
        document.getElementById('current-year').textContent = now.getFullYear();
        
        // 设置日期输入框默认值为今天
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                // 使用格式化的日期字符串，避免时区问题
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
            
            // 设置日期区间默认值（本月）
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            // 获取本月第一天
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            // 获取本月最后一天
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // 格式化日期为YYYY-MM-DD格式
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            startDateInput.value = formatDate(firstDay);
            endDateInput.value = formatDate(lastDay);
        });

        // 初始化IndexedDB数据库
        let db;
        const DB_NAME = 'PersonalFinanceDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'transactions';

        // 图表实例
        let expenseChart = null;
        let incomeChart = null; // 新增收入图表实例
        
        // 当前编辑状态
        let isEditing = false;
        let currentEditId = null;
        
        // 当前日期区间筛选状态
        let currentDateRange = null;
        
        // 当前搜索状态
        let currentSearchTerm = '';
        let currentSearchType = 'all'; // all, description, category, amount
        
        // 待删除的记录ID
        let pendingDeleteId = null;

        // 初始化数据库
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('数据库打开失败');
                    reject('数据库打开失败');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('数据库打开成功');
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // 创建事务存储对象
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id',
                            autoIncrement: true 
                        });
                        
                        // 创建索引以便查询
                        objectStore.createIndex('type', 'type', { unique: false });
                        objectStore.createIndex('category', 'category', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });
                        
                        console.log('数据库结构创建成功');
                    }
                };
            });
        }

        // 添加交易记录
        async function addTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                
                // 添加时间戳作为ID的一部分
                if (!transaction.id) {
                    transaction.id = Date.now() + Math.floor(Math.random() * 1000);
                }
                
                // 如果没有描述，使用默认描述
                if (!transaction.description || transaction.description.trim() === '') {
                    const categoryText = getCategoryText(transaction.category);
                    transaction.description = `${categoryText}${transaction.type === 'income' ? '收入' : '支出'}`;
                }
                
                const request = store.add(transaction);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('添加交易记录失败');
                };
            });
        }

        // 更新交易记录
        async function updateTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                
                // 如果没有描述，使用默认描述
                if (!transaction.description || transaction.description.trim() === '') {
                    const categoryText = getCategoryText(transaction.category);
                    transaction.description = `${categoryText}${transaction.type === 'income' ? '收入' : '支出'}`;
                }
                
                const request = store.put(transaction);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('更新交易记录失败');
                };
            });
        }

        // 获取所有交易记录
        async function getAllTransactions() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('获取交易记录失败');
                };
            });
        }

        // 根据日期区间获取交易记录
        async function getTransactionsByDateRange(startDate, endDate) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const index = store.index('date');
                
                // 创建日期范围
                const range = IDBKeyRange.bound(startDate, endDate);
                const request = index.getAll(range);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('按日期区间获取交易记录失败');
                };
            });
        }

        // 根据ID获取交易记录
        async function getTransactionById(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(id);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('获取交易记录失败');
                };
            });
        }

        // 根据类型获取交易记录
        async function getTransactionsByType(type) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const index = store.index('type');
                const request = index.getAll(type);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('按类型获取交易记录失败');
                };
            });
        }

        // 根据分类获取交易记录
        async function getTransactionsByCategory(category) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const index = store.index('category');
                const request = index.getAll(category);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject('按分类获取交易记录失败');
                };
            });
        }

        // 删除交易记录
        async function deleteTransaction(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = () => {
                    reject('删除交易记录失败');
                };
            });
        }

        // 搜索交易记录
        function searchTransactions(transactions, searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                return transactions;
            }
            
            const term = searchTerm.toLowerCase().trim();
            return transactions.filter(transaction => {
                // 搜索描述
                if (transaction.description && transaction.description.toLowerCase().includes(term)) {
                    return true;
                }
                
                // 搜索分类
                const categoryText = getCategoryText(transaction.category).toLowerCase();
                if (categoryText.includes(term)) {
                    return true;
                }
                
                // 搜索金额
                const amountStr = transaction.amount.toString();
                if (amountStr.includes(term)) {
                    return true;
                }
                
                // 搜索交易类型
                const typeText = transaction.type === 'income' ? '收入' : '支出';
                if (typeText.includes(term)) {
                    return true;
                }
                
                return false;
            });
        }

        // 高亮搜索关键词
        function highlightSearchText(text, searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                return text;
            }
            
            const term = searchTerm.toLowerCase();
            const lowerText = text.toLowerCase();
            let result = '';
            let lastIndex = 0;
            
            for (let i = 0; i <= lowerText.length - term.length; i++) {
                if (lowerText.substring(i, i + term.length) === term) {
                    result += text.substring(lastIndex, i);
                    result += `<span class="search-highlight">${text.substring(i, i + term.length)}</span>`;
                    i += term.length - 1;
                    lastIndex = i + 1;
                }
            }
            
            result += text.substring(lastIndex);
            return result;
        }

        // 导出数据
        async function exportData() {
            try {
                const transactions = await getAllTransactions();
                
                // 创建导出数据对象
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    transactions: transactions
                };
                
                // 转换为JSON字符串
                const dataStr = JSON.stringify(exportData, null, 2);
                
                // 创建Blob对象
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // 创建下载链接
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `财务数据_${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日.json`;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showNotification('数据导出成功！', 'success');
                
            } catch (error) {
                console.error('导出数据失败:', error);
                showNotification('导出数据失败，请重试', 'error');
            }
        }

        // 导入数据
        async function importData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(event) {
                    try {
                        const importData = JSON.parse(event.target.result);
                        
                        // 验证数据格式
                        if (!importData.transactions || !Array.isArray(importData.transactions)) {
                            reject('文件格式不正确，缺少交易记录数据');
                            return;
                        }
                        
                        let importedCount = 0;
                        let skippedCount = 0;
                        
                        // 批量导入数据
                        for (const transaction of importData.transactions) {
                            try {
                                // 检查是否已存在相同ID的记录
                                const existing = await getTransactionById(transaction.id);
                                
                                if (existing) {
                                    skippedCount++;
                                    continue; // 跳过已存在的记录
                                }
                                
                                await addTransaction(transaction);
                                importedCount++;
                            } catch (error) {
                                console.error('导入单条记录失败:', error);
                                skippedCount++;
                            }
                        }
                        
                        resolve({ importedCount, skippedCount });
                        
                    } catch (error) {
                        reject('解析文件失败，请确保文件格式正确');
                    }
                };
                
                reader.onerror = function() {
                    reject('读取文件失败');
                };
                
                reader.readAsText(file);
            });
        }

        // 切换图表容器的展开/折叠状态
        function toggleChartContainer(containerId) {
            const container = document.getElementById(containerId);
            const toggleTitle = document.getElementById(containerId.replace('-container', '-toggle'));
            
            if (container.classList.contains('collapsed')) {
                // 展开
                container.classList.remove('collapsed');
                toggleTitle.classList.remove('collapsed');
                
                // 如果是收入图表且尚未加载，则加载图表
                if (containerId === 'income-chart-container') {
                    setTimeout(() => updateIncomeChart(), 100);
                }
                
                // 如果是支出图表且尚未加载，则加载图表
                if (containerId === 'expense-chart-container') {
                    setTimeout(() => updateExpenseChart(), 100);
                }
            } else {
                // 折叠
                container.classList.add('collapsed');
                toggleTitle.classList.add('collapsed');
            }
        }

        // 初始化应用程序
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 修改：设置新增记录按钮事件 - 打开模态窗口
                document.getElementById('add-record-btn').addEventListener('click', function() {
                    openTransactionModal('add');
                });
                
                // 设置表单提交事件
                document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
                
                // 设置筛选按钮事件
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 移除所有按钮的active类
                        document.querySelectorAll('.filter-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        
                        // 为当前按钮添加active类
                        this.classList.add('active');
                        
                        // 根据筛选条件加载交易记录
                        const filter = this.getAttribute('data-filter');
                        filterTransactions(filter);
                    });
                });
                
                // 设置日期区间快速选择按钮事件
                document.querySelectorAll('.quick-date-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 移除所有按钮的active类
                        document.querySelectorAll('.quick-date-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        
                        // 为当前按钮添加active类
                        this.classList.add('active');
                        
                        // 设置日期区间
                        const range = this.getAttribute('data-range');
                        setQuickDateRange(range);
                    });
                });
                
                // 设置应用日期区间按钮事件
                document.getElementById('apply-date-range').addEventListener('click', applyDateRange);
                
                // 设置重置日期区间按钮事件
                document.getElementById('reset-date-range').addEventListener('click', resetDateRange);
                
                // 设置导出按钮事件
                document.getElementById('export-btn').addEventListener('click', exportData);
                
                // 设置导入按钮事件
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('import-modal').style.display = 'block';
                });
                
                // 设置搜索输入事件
                const searchInput = document.getElementById('search-input');
                let searchTimeout;
                
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim();
                        performSearch(searchTerm);
                    }, 300); // 防抖处理，300毫秒后执行搜索
                });
                
                // 设置清除搜索按钮事件
                document.getElementById('clear-search-btn').addEventListener('click', function() {
                    clearSearch();
                });
                
                // 设置文件选择事件
                document.getElementById('import-file').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('file-name').textContent = file.name;
                    } else {
                        document.getElementById('file-name').textContent = '未选择文件';
                    }
                });
                
                // 设置确认导入事件
                document.getElementById('confirm-import').addEventListener('click', async () => {
                    const fileInput = document.getElementById('import-file');
                    const file = fileInput.files[0];
                    
                    if (!file) {
                        showNotification('请选择要导入的文件', 'error');
                        return;
                    }
                    
                    const importBtn = document.getElementById('confirm-import');
                    const originalBtnText = importBtn.innerHTML;
                    
                    // 显示加载状态
                    importBtn.innerHTML = '<div class="loading" style="display: inline-block; margin-right: 8px;"></div>导入中...';
                    importBtn.disabled = true;
                    
                    try {
                        const result = await importData(file);
                        
                        // 重新加载数据
                        const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
                        await filterTransactions(activeFilter);
                        
                        // 更新统计信息
                        updateStatistics();
                        
                        // 更新图表
                        await updateCharts();
                        
                        // 关闭模态框
                        closeModal();
                        
                        // 显示成功消息
                        showNotification(`数据导入成功！导入${result.importedCount}条记录，跳过${result.skippedCount}条重复记录`, 'success');
                        
                        // 重置文件输入
                        fileInput.value = '';
                        document.getElementById('file-name').textContent = '未选择文件';
                        
                    } catch (error) {
                        console.error('导入数据失败:', error);
                        showNotification(`导入数据失败: ${error}`, 'error');
                    } finally {
                        // 恢复按钮状态
                        importBtn.innerHTML = originalBtnText;
                        importBtn.disabled = false;
                    }
                });
                
                // 设置模态框关闭事件
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', function() {
						const modalId = this.closest('.modal').id;
						closeModal(modalId);
					});
                });
                
                // 点击模态框外部关闭
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal')) {
						closeModal(event.target.id);
					}
                });
                
                // 添加图表折叠/展开功能
                document.getElementById('income-chart-toggle').addEventListener('click', function() {
                    toggleChartContainer('income-chart-container');
                });
                
                document.getElementById('expense-chart-toggle').addEventListener('click', function() {
                    toggleChartContainer('expense-chart-container');
                });
                
                // 添加删除确认按钮事件
                document.getElementById('confirm-delete').addEventListener('click', async function() {
                    if (!pendingDeleteId) return;
                    
                    const deleteBtn = this;
                    const originalBtnText = deleteBtn.innerHTML;
                    
                    // 显示加载状态
                    deleteBtn.innerHTML = '<div class="loading" style="display: inline-block; margin-right: 8px;"></div>删除中...';
                    deleteBtn.disabled = true;
                    
                    try {
                        await deleteTransaction(pendingDeleteId);
                        
                        // 如果正在编辑的记录被删除，取消编辑状态
                        if (isEditing && currentEditId === pendingDeleteId) {
                            isEditing = false;
                            currentEditId = null;
                        }
                        
                        // 重新加载交易记录
                        const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
                        await filterTransactions(activeFilter);
                        
                        // 更新统计信息
                        updateStatistics();
                        
                        // 更新图表
                        await updateCharts();
                        
                        // 更新日期区间统计
                        updateDateRangeSummary();
                        
                        // 显示成功消息
                        showNotification('交易记录已删除', 'success');
                        
                        // 关闭模态框
                        closeModal('delete-confirm-modal');
                        
                    } catch (error) {
                        console.error('删除交易记录失败:', error);
                        showNotification('删除交易记录失败，请重试', 'error');
                        
                        // 恢复按钮状态
                        deleteBtn.innerHTML = originalBtnText;
                        deleteBtn.disabled = false;
                    }
                });
                
                // 初始化数据库
                await initDB();
                
                // 加载交易记录
                await loadTransactions();
                
                // 更新统计信息
                updateStatistics();
                
                // 加载Chart.js并更新图表
                await loadChartJS();
                
                // 默认只更新支出图表（因为收入图表默认是折叠的）
                if (!document.getElementById('expense-chart-container').classList.contains('collapsed')) {
                    await updateExpenseChart();
                }
                
                // 应用默认日期区间（本月）
                applyDateRange();
                
                // 添加一些示例数据（如果数据库为空）
                const transactions = await getAllTransactions();
                // if (transactions.length === 0) {
                //     await addSampleData();
                // }
                
            } catch (error) {
                console.error('应用程序初始化失败:', error);
                showNotification('应用程序初始化失败，请刷新页面重试', 'error');
            }
        });

        // 打开交易记录模态窗口
        function openTransactionModal(mode = 'add', transactionId = null) {
            // 重置表单
            document.getElementById('transaction-form').reset();
            
            // 设置表单默认值
            document.getElementById('type').value = 'expense';
            document.getElementById('category').value = 'food';
            
            // 设置日期为今天
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
            
            // 清除编辑ID
            document.getElementById('edit-id').value = '';
            
            if (mode === 'add') {
                // 添加模式
                document.getElementById('modal-form-title').textContent = '添加交易记录';
                isEditing = false;
                currentEditId = null;
            } else if (mode === 'edit' && transactionId) {
                // 编辑模式
                document.getElementById('modal-form-title').textContent = '编辑交易记录';
                // 加载交易记录数据
                loadTransactionForEdit(transactionId);
            }
            
            // 显示模态窗口
            document.getElementById('transaction-modal').style.display = 'block';
        }

        // 加载交易记录数据用于编辑
        async function loadTransactionForEdit(id) {
            try {
                const transaction = await getTransactionById(id);
                
                if (transaction) {
                    // 填充表单
                    document.getElementById('edit-id').value = transaction.id;
                    document.getElementById('type').value = transaction.type;
                    document.getElementById('category').value = transaction.category;
                    document.getElementById('amount').value = transaction.amount;
                    document.getElementById('description').value = transaction.description || '';
                    document.getElementById('date').value = transaction.date;
                    
                    // 设置编辑状态
                    isEditing = true;
                    currentEditId = transaction.id;
                }
            } catch (error) {
                console.error('加载交易记录失败:', error);
                showNotification('加载交易记录失败，请重试', 'error');
                closeModal('transaction-modal');
            }
        }

        // 执行搜索
        function performSearch(searchTerm) {
            currentSearchTerm = searchTerm;
            
            if (searchTerm) {
                // 显示搜索结果信息
                document.getElementById('search-results-info').style.display = 'flex';
                
                // 更新搜索标签
                updateSearchTags(searchTerm);
                
                // 显示搜索操作区域
                document.getElementById('search-actions').style.display = 'flex';
            } else {
                // 隐藏搜索结果信息
                document.getElementById('search-results-info').style.display = 'none';
                
                // 隐藏搜索操作区域
                document.getElementById('search-actions').style.display = 'none';
            }
            
            // 重新筛选交易记录
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            filterTransactions(activeFilter);
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('search-input').value = '';
            currentSearchTerm = '';
            
            // 隐藏搜索结果信息
            document.getElementById('search-results-info').style.display = 'none';
            
            // 隐藏搜索操作区域
            document.getElementById('search-actions').style.display = 'none';
            
            // 重新筛选交易记录
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            filterTransactions(activeFilter);
            
            showNotification('已清除搜索条件', 'info');
        }

        // 更新搜索标签
        function updateSearchTags(searchTerm) {
            const searchActions = document.getElementById('search-actions');
            searchActions.innerHTML = '';
            
            if (searchTerm) {
                const tag = document.createElement('div');
                tag.className = 'search-tag';
                tag.innerHTML = `
                    搜索: "${searchTerm}"
                    <button type="button" class="clear-tag-btn" title="清除搜索">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                tag.querySelector('.clear-tag-btn').addEventListener('click', function() {
                    clearSearch();
                });
                
                searchActions.appendChild(tag);
            }
        }

        // 处理表单提交
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submit-btn');
            const originalBtnText = submitBtn.innerHTML;
            
            // 显示加载状态
            submitBtn.innerHTML = '<div class="loading" style="display: inline-block; margin-right: 8px;"></div>保存中...';
            submitBtn.disabled = true;
            
            const transaction = {
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseFloat(formData.get('amount')),
                description: formData.get('description'),
                date: formData.get('date')
            };
            
            try {
                if (isEditing && currentEditId) {
                    // 更新现有记录
                    transaction.id = currentEditId;
                    await updateTransaction(transaction);
                    
                    // 重置编辑状态
                    isEditing = false;
                    currentEditId = null;
                    
                    showNotification('交易记录已更新成功！', 'success');
                } else {
                    // 添加新记录
                    await addTransaction(transaction);
                    
                    showNotification('交易记录已添加成功！', 'success');
                }
                
                // 重新加载交易记录
                const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
                await filterTransactions(activeFilter);
                
                // 更新统计信息
                updateStatistics();
                
                // 更新图表
                await updateCharts();
                
                // 更新日期区间统计
                updateDateRangeSummary();
                
                // 关闭模态窗口
                closeModal('transaction-modal');
                
            } catch (error) {
                console.error('保存交易记录失败:', error);
                showNotification('保存交易记录失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        // 设置快速日期区间
        function setQuickDateRange(range) {
			const startDateInput = document.getElementById('start-date');
			const endDateInput = document.getElementById('end-date');
			
			// 获取当前选择的日期或默认使用今天
			let baseDate = new Date();
			
			// 如果开始日期输入框有值，则基于该日期计算
			if (startDateInput.value) {
				baseDate = new Date(startDateInput.value);
			}
			
			let startDate = new Date(baseDate);
			let endDate = new Date(baseDate);
			
			// 格式化日期为YYYY-MM-DD格式
			const formatDate = (date) => {
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				return `${year}-${month}-${day}`;
			};
			
			switch(range) {
				case 'today':
					baseDate = new Date();
					startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
					endDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
					break;
				case 'week':
					baseDate = new Date();
					// 获取本周第一天（周一）
					const day = baseDate.getDay();
					const diff = baseDate.getDate() - day + (day === 0 ? -6 : 1);
					startDate = new Date(baseDate.setDate(diff));
					// 本周最后一天（周日）
					endDate = new Date(startDate);
					endDate.setDate(startDate.getDate() + 6);
					break;
				case 'month':
					baseDate = new Date();
					// 本月第一天
					startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
					// 本月最后一天
					endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
					break;
				case 'prev-month':
					baseDate = new Date(startDateInput.value);
					// 上个月第一天
					startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
					// 上个月最后一天
					endDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 0);
					break;
				case 'next-month':
					baseDate = new Date(startDateInput.value);
					// 下个月第一天
					startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 1);
					// 下个月最后一天
					endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 2, 0);
					break;
				case 'year':
					baseDate = new Date();
					// 今年第一天
					startDate = new Date(baseDate.getFullYear(), 0, 1);
					// 今年最后一天
					endDate = new Date(baseDate.getFullYear(), 11, 31);
					break;
				case 'all':
					// 设置为最早和最晚的日期
					startDate = new Date(2000, 0, 1);
					endDate = new Date(2100, 11, 31);
					break;
			}
			
			// 设置日期输入框的值
			startDateInput.value = formatDate(startDate);
			endDateInput.value = formatDate(endDate);
			
			// 自动统计
			applyDateRange();
		}

        // 应用日期区间
		async function applyDateRange() {
			const startDateInput = document.getElementById('start-date');
			const endDateInput = document.getElementById('end-date');
			
			const startDate = startDateInput.value;
			const endDate = endDateInput.value;
			
			if (!startDate || !endDate) {
				showNotification('请选择开始日期和结束日期', 'error');
				return;
			}
			
			if (startDate > endDate) {
				showNotification('开始日期不能晚于结束日期', 'error');
				return;
			}
			
			// 保存当前日期区间
			currentDateRange = { startDate, endDate };
			
			// 更新日期区间标题
			const startDateObj = new Date(startDate);
			const endDateObj = new Date(endDate);
			const dateRangeTitle = `${startDateObj.getFullYear()}年${startDateObj.getMonth() + 1}月${startDateObj.getDate()}日 - ${endDateObj.getFullYear()}年${endDateObj.getMonth() + 1}月${endDateObj.getDate()}日`;
			document.getElementById('date-range-title').textContent = dateRangeTitle;
			
			// 显示日期区间统计区域
			// document.getElementById('date-range-summary').style.display = 'flex';
			
			// 加载指定日期区间的交易记录
			await loadTransactionsByDateRange(startDate, endDate);
			
			// 更新日期区间统计
			updateDateRangeSummary();
			
			// 新增：更新顶部统计信息（总收入、总支出、当前余额）
			await updateStatistics();
			
			// 新增：更新图表
			await updateCharts();
			
			showNotification(`已应用日期区间: ${dateRangeTitle}`, 'success');
		}

        // 重置日期区间
		async function resetDateRange() {
			// 重置日期区间
			currentDateRange = null;
			
			// 隐藏日期区间统计区域
			// document.getElementById('date-range-summary').style.display = 'none';
			
			// 重置快速日期按钮
			document.querySelectorAll('.quick-date-btn').forEach(b => {
				b.classList.remove('active');
			});
			document.querySelector('.quick-date-btn[data-range="month"]').classList.add('active');
			
			// 重新加载所有交易记录
			const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
			await filterTransactions(activeFilter);
			
			// 更新统计信息（这里会计算全部数据的统计）
			await updateStatistics();
			
			// 更新图表
			await updateCharts();
			
			showNotification('已重置日期区间', 'info');
		}

        // 加载指定日期区间的交易记录
		async function loadTransactionsByDateRange(startDate, endDate) {
			try {
				const transactions = await getTransactionsByDateRange(startDate, endDate);
				
				// 获取当前筛选类型
				const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
				
				// 根据筛选类型过滤交易记录
				let filteredTransactions = transactions;
				
				if (activeFilter === 'income') {
					filteredTransactions = transactions.filter(t => t.type === 'income');
				} else if (activeFilter === 'expense') {
					filteredTransactions = transactions.filter(t => t.type === 'expense');
				} else if (activeFilter !== 'all') {
					filteredTransactions = transactions.filter(t => t.category === activeFilter);
				}
				
				// 应用搜索过滤
				filteredTransactions = searchTransactions(filteredTransactions, currentSearchTerm);
				
				// 显示交易记录
				displayTransactions(filteredTransactions);
				
				// 新增：更新统计信息
				await updateStatistics();
				
				// 新增：更新图表
				await updateCharts();
				
			} catch (error) {
				console.error('加载日期区间交易记录失败:', error);
			}
		}

        // 更新日期区间统计
        async function updateDateRangeSummary() {
            if (!currentDateRange) return;
            
            try {
                const transactions = await getTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate);
                
                let totalIncome = 0;
                let totalExpense = 0;
                
                transactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else {
                        totalExpense += transaction.amount;
                    }
                });
                
                const balance = totalIncome - totalExpense;
                
                // 更新DOM
                document.getElementById('date-range-total').textContent = 
                    `总收入: ¥${totalIncome.toFixed(2)} | 总支出: ¥${totalExpense.toFixed(2)} | 结余: ¥${balance.toFixed(2)}`;
                
            } catch (error) {
                console.error('更新日期区间统计失败:', error);
            }
        }

        // 加载交易记录
        async function loadTransactions(filter = 'all') {
            if (currentDateRange) {
                // 如果有日期区间筛选，加载指定日期区间的记录
                await loadTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate);
                updateDateRangeSummary();
            } else {
                // 否则，按类型/分类筛选
                await filterTransactions(filter);
            }
        }

        // 筛选交易记录
		async function filterTransactions(filter) {
			let transactions = [];
			
			try {
				// 如果当前有日期区间筛选，先获取日期区间内的记录
				if (currentDateRange) {
					transactions = await getTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate);
				} else {
					transactions = await getAllTransactions();
				}
				
				// 根据筛选类型过滤交易记录
				let filteredTransactions = transactions;
				
				if (filter === 'income') {
					filteredTransactions = transactions.filter(t => t.type === 'income');
				} else if (filter === 'expense') {
					filteredTransactions = transactions.filter(t => t.type === 'expense');
				} else if (filter !== 'all') {
					filteredTransactions = transactions.filter(t => t.category === filter);
				}
				
				// 应用搜索过滤
				filteredTransactions = searchTransactions(filteredTransactions, currentSearchTerm);
				
				// 显示交易记录
				displayTransactions(filteredTransactions);
				
				// 更新搜索结果信息
				if (currentSearchTerm) {
					document.getElementById('search-results-count').textContent = filteredTransactions.length;
				}
				
				// 新增：更新统计信息
				await updateStatistics();
				
				// 新增：更新日期区间统计
				if (currentDateRange) {
					updateDateRangeSummary();
				}
				
			} catch (error) {
				console.error('筛选交易记录失败:', error);
			}
		}
		
		// 获取星期几
		function getDayOfWeek(date) {
			const dayOfWeek = date.getDay();
			const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
			return weekdays[dayOfWeek];
		}

        // 显示交易记录
        function displayTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            
            if (transactions.length === 0) {
                let message = '暂无交易记录';
                if (currentSearchTerm) {
                    message = `未找到包含"${currentSearchTerm}"的交易记录`;
                } else if (currentDateRange) {
                    const startDate = new Date(currentDateRange.startDate);
                    const endDate = new Date(currentDateRange.endDate);
                    const dateRangeText = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月${startDate.getDate()}日 - ${endDate.getFullYear()}年${endDate.getMonth() + 1}月${endDate.getDate()}日`;
                    message = `在${dateRangeText}期间暂无交易记录`;
                }
                
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>${message}</h3>
                        <p>${currentSearchTerm ? '尝试更换搜索关键词或清除搜索条件' : '添加您的第一笔交易记录以开始追踪财务状况'}</p>
                    </div>
                `;
                return;
            }
            
            // 按日期排序（最新的在前）
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
			let trans_i = 0;
			let trans_count = transactions.length;
            
            transactions.forEach(transaction => {
                const isIncome = transaction.type === 'income';
                const amountClass = isIncome ? 'income-text' : 'expense-text';
                const amountPrefix = isIncome ? '+' : '-';
                const categoryClass = `category-${transaction.category}`;
                const categoryText = getCategoryText(transaction.category);
				trans_i++;
                
                // 格式化日期
                const date = new Date(transaction.date);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
				const dayOfWeek = getDayOfWeek(date);
                
                // 高亮搜索关键词
                let highlightedDescription = transaction.description;
                let highlightedCategory = categoryText;
                
                if (currentSearchTerm) {
                    highlightedDescription = highlightSearchText(transaction.description, currentSearchTerm);
                    highlightedCategory = highlightSearchText(categoryText, currentSearchTerm);
                }
                
                html += `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <h4>${trans_i}. ${highlightedDescription}</h4>
                            <span class="transaction-category ${categoryClass}">${formattedDate} ${dayOfWeek} • ${highlightedCategory}</span>
                        </div>
                        <div class="transaction-actions">
                            <span class="transaction-amount ${amountClass}">${amountPrefix}¥${transaction.amount.toFixed(2)}</span>
                            <button class="edit-btn" data-id="${transaction.id}" title="编辑记录">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" data-id="${transaction.id}" title="删除记录">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加编辑按钮事件
            container.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    // 打开编辑模态窗口
                    openTransactionModal('edit', id);
                });
            });
            
            // 添加删除按钮事件
            container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    
                    // 存储待删除的ID
					pendingDeleteId = id;
					
					// 获取交易记录详情，用于显示在确认对话框中
					try {
						const transaction = await getTransactionById(id);
						if (transaction) {
							const categoryText = getCategoryText(transaction.category);
							const amount = transaction.amount.toFixed(2);
							const date = new Date(transaction.date);
							const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
							
							// 更新确认对话框内容
							const modalContent = document.querySelector('#delete-confirm-modal .modal-content');
							const warningIcon = modalContent.querySelector('.fa-exclamation-triangle');
							const message = modalContent.querySelector('p:nth-child(2)');
							
							// 更新消息内容
							message.innerHTML = `确定要删除这条交易记录吗？<br><strong>${transaction.description}</strong>`;
							
							// 添加详情信息
							let details = modalContent.querySelector('.delete-details');
							if (!details) {
								details = document.createElement('div');
								details.className = 'delete-details';
								details.style.marginTop = '15px';
								details.style.padding = '10px';
								details.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
								details.style.borderRadius = '8px';
								details.style.fontSize = '0.9rem';
								message.parentNode.insertBefore(details, message.nextSibling);
							}
							
							details.innerHTML = `
								<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
									<span>金额:</span>
									<span style="font-weight: 600; color: ${transaction.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)'}">
										${transaction.type === 'income' ? '+' : '-'}¥${amount}
									</span>
								</div>
								<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
									<span>分类:</span>
									<span>${categoryText}</span>
								</div>
								<div style="display: flex; justify-content: space-between;">
									<span>日期:</span>
									<span>${formattedDate}</span>
								</div>
							`;
						}
					} catch (error) {
						console.error('获取交易记录详情失败:', error);
					}
					
					// 显示删除确认模态框
					document.getElementById('delete-confirm-modal').style.display = 'block';
                });
            });
        }

        // 更新统计信息
		async function updateStatistics() {
			try {
				// 获取交易记录：如果有日期区间筛选，则获取日期区间内的记录，否则获取所有记录
				let transactions;
				if (currentDateRange) {
					transactions = await getTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate);
				} else {
					transactions = await getAllTransactions();
				}
				
				let totalIncome_i = 0;
				let totalIncome = 0;
				let totalExpense_i = 0;
				let totalExpense = 0;
				
				transactions.forEach(transaction => {
					if (transaction.type === 'income') {
						totalIncome_i += 1;
						totalIncome += transaction.amount;
					} else {
						totalExpense_i += 1;
						totalExpense += transaction.amount;
					}
				});
				
				const balance = totalIncome - totalExpense;
				
				// 更新DOM
				document.getElementById('total-income').textContent = `${totalIncome_i}笔 ¥${totalIncome.toFixed(2)}`;
				document.getElementById('total-expense').textContent = `${totalExpense_i}笔 ¥${totalExpense.toFixed(2)}`;
				document.getElementById('current-balance').textContent = `¥${balance.toFixed(2)}`;
				
			} catch (error) {
				console.error('更新统计信息失败:', error);
			}
		}

        // 更新所有图表
        async function updateCharts() {
            // 只更新非折叠状态的图表
            if (!document.getElementById('expense-chart-container').classList.contains('collapsed')) {
                await updateExpenseChart();
            }
            if (!document.getElementById('income-chart-container').classList.contains('collapsed')) {
                await updateIncomeChart();
            }
        }

        // 更新支出图表
        async function updateExpenseChart() {
            const container = document.getElementById('expense-chart-container');
            
            // 如果容器是折叠状态，不更新图表
            if (container.classList.contains('collapsed')) {
                return;
            }
            
            try {
                // 确保Chart.js已加载
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js未加载，正在重试...');
                    await loadChartJS();
                }
                
                const transactions = currentDateRange ? 
                    await getTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate) : 
                    await getAllTransactions();
                
                // 只统计支出
                const expenseTransactions = transactions.filter(t => t.type === 'expense');
                
                // 如果没有支出数据，显示空状态
                if (expenseTransactions.length === 0) {
                    document.getElementById('expenseChart').style.display = 'none';
                    document.getElementById('expense-chart-placeholder').style.display = 'block';
                    document.getElementById('expense-chart-legend').innerHTML = '';
                    return;
                }
                
                // 显示图表
                document.getElementById('expenseChart').style.display = 'block';
                document.getElementById('expense-chart-placeholder').style.display = 'none';
                
                // 按分类统计支出
                const categories = {
                    food: 0,
                    transport: 0,
                    entertainment: 0,
                    shopping: 0,
                    bills: 0,
                    other: 0
                };
                
                expenseTransactions.forEach(transaction => {
                    if (categories.hasOwnProperty(transaction.category)) {
                        categories[transaction.category] += transaction.amount;
                    } else {
                        categories.other += transaction.amount;
                    }
                });
                
                // 过滤掉值为0的分类
                const filteredCategories = {};
                const filteredLabels = [];
                const filteredData = [];
                const filteredColors = [];
                
                const categoryColors = {
                    food: '#ef4444',
                    transport: '#3b82f6',
                    entertainment: '#a855f7',
                    shopping: '#f59e0b',
                    bills: '#06b6d4',
                    other: '#94a3b8'
                };
                
                Object.keys(categories).forEach(category => {
                    if (categories[category] > 0) {
                        filteredCategories[category] = categories[category];
                        filteredLabels.push(getCategoryText(category));
                        filteredData.push(categories[category]);
                        filteredColors.push(categoryColors[category]);
                    }
                });
                
                // 更新图例
                const legendContainer = document.getElementById('expense-chart-legend');
                let legendHtml = '';
                
                Object.keys(filteredCategories).forEach((category, index) => {
                    legendHtml += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${filteredColors[index]}"></div>
                            <span>${getCategoryText(category)}: ¥${filteredCategories[category].toFixed(2)}</span>
                        </div>
                    `;
                });
                
                legendContainer.innerHTML = legendHtml;
                
                // 获取canvas上下文
                const ctx = document.getElementById('expenseChart').getContext('2d');
                
                // 如果图表已存在，销毁它
                if (expenseChart) {
                    expenseChart.destroy();
                }
                
                // 创建新图表
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: filteredLabels,
                        datasets: [{
                            data: filteredData,
                            backgroundColor: filteredColors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('更新支出图表失败:', error);
                // 如果图表创建失败，显示空状态
                document.getElementById('expenseChart').style.display = 'none';
                document.getElementById('expense-chart-placeholder').style.display = 'block';
            }
        }

        // 更新收入图表
        async function updateIncomeChart() {
            const container = document.getElementById('income-chart-container');
            
            // 如果容器是折叠状态，不更新图表
            if (container.classList.contains('collapsed')) {
                return;
            }
            
            try {
                // 确保Chart.js已加载
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js未加载，正在重试...');
                    await loadChartJS();
                }
                
                const transactions = currentDateRange ? 
                    await getTransactionsByDateRange(currentDateRange.startDate, currentDateRange.endDate) : 
                    await getAllTransactions();
                
                // 只统计收入
                const incomeTransactions = transactions.filter(t => t.type === 'income');
                
                // 如果没有收入数据，显示空状态
                if (incomeTransactions.length === 0) {
                    document.getElementById('incomeChart').style.display = 'none';
                    document.getElementById('income-chart-placeholder').style.display = 'block';
                    document.getElementById('income-chart-legend').innerHTML = '';
                    return;
                }
                
                // 显示图表
                document.getElementById('incomeChart').style.display = 'block';
                document.getElementById('income-chart-placeholder').style.display = 'none';
                
                // 按分类统计收入
                const categories = {
					food: 0,
					transport: 0,
					entertainment: 0,
					shopping: 0,
					bills: 0,
                    salary: 0,
                    other: 0
                };
                
                incomeTransactions.forEach(transaction => {
                    if (categories.hasOwnProperty(transaction.category)) {
                        categories[transaction.category] += transaction.amount;
                    } else {
                        categories.other += transaction.amount;
                    }
                });
                
                // 过滤掉值为0的分类
                const filteredCategories = {};
                const filteredLabels = [];
                const filteredData = [];
                const filteredColors = [];
                
                const incomeCategoryColors = {
                    food: '#ef4444',
                    transport: '#3b82f6',
                    entertainment: '#a855f7',
                    shopping: '#f59e0b',
                    bills: '#06b6d4',
					salary: '#10b981',
                    other: '#94a3b8'					
                };
                
                Object.keys(categories).forEach(category => {
                    if (categories[category] > 0) {
                        filteredCategories[category] = categories[category];
                        filteredLabels.push(getCategoryText(category));
                        filteredData.push(categories[category]);
                        filteredColors.push(incomeCategoryColors[category] || '#3b82f6');
                    }
                });
                
                // 更新图例
                const legendContainer = document.getElementById('income-chart-legend');
                let legendHtml = '';
                
                Object.keys(filteredCategories).forEach((category, index) => {
                    legendHtml += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${filteredColors[index]}"></div>
                            <span>${getCategoryText(category)}: ¥${filteredCategories[category].toFixed(2)}</span>
                        </div>
                    `;
                });
                
                legendContainer.innerHTML = legendHtml;
                
                // 获取canvas上下文
                const ctx = document.getElementById('incomeChart').getContext('2d');
                
                // 如果图表已存在，销毁它
                if (incomeChart) {
                    incomeChart.destroy();
                }
                
                // 创建新图表
                incomeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: filteredLabels,
                        datasets: [{
                            data: filteredData,
                            backgroundColor: filteredColors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('更新收入图表失败:', error);
                // 如果图表创建失败，显示空状态
                document.getElementById('incomeChart').style.display = 'none';
                document.getElementById('income-chart-placeholder').style.display = 'block';
            }
        }

        // 修改closeModal函数以接受参数
		function closeModal(modalId = null) {
			if (modalId) {
				document.getElementById(modalId).style.display = 'none';
			} else {
				// 如果没有指定modalId，关闭所有打开的模态框
				document.querySelectorAll('.modal').forEach(modal => {
					modal.style.display = 'none';
				});
			}
			
			// 重置删除相关状态
			pendingDeleteId = null;
		}

        // 获取分类文本
        function getCategoryText(category) {
            const categoryMap = {
                salary: '工资收入',
                food: '餐饮食品',
                transport: '交通出行',
                entertainment: '娱乐休闲',
                shopping: '购物消费',
                bills: '生活账单',
                other: '其他'
            };
            
            return categoryMap[category] || category;
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // 样式
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '8px';
            notification.style.color = 'white';
            notification.style.fontWeight = '500';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            notification.style.transform = 'translateX(100%)';
            notification.style.transition = 'transform 0.3s ease';
            
            // 根据类型设置背景颜色
            if (type === 'success') {
                notification.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#ef4444';
            } else {
                notification.style.backgroundColor = '#3b82f6';
            }
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 添加示例数据
        async function addSampleData() {
            const sampleTransactions = [
                {
                    id: Date.now() + 1,
                    type: 'income',
                    category: 'salary',
                    amount: 9600.00,
                    description: '月度工资',
                    date: new Date().toISOString().split('T')[0]
                },
               
                {
                    id: Date.now() + 6,
                    type: 'expense',
                    category: 'entertainment',
                    amount: 180.00,
                    description: '电影票',
                    date: new Date(Date.now() - 4 * 86400000).toISOString().split('T')[0]
                }
            ];
            
            try {
                for (const transaction of sampleTransactions) {
                    await addTransaction(transaction);
                }
                
                console.log('示例数据添加成功');
                
                // 重新加载数据
                await loadTransactions();
                updateStatistics();
                await updateCharts();
                
            } catch (error) {
                console.error('添加示例数据失败:', error);
            }
        }
    </script>
</body>
</html>
