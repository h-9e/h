<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YiShare</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        body {
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .header h1 {
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        .main {
            padding: 25px;
        }
        /* 连接码区域 */
        .code-area {
            text-align: center;
            margin-bottom: 30px;
        }
        .code-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 3px;
            color: #2196F3;
            margin: 15px 0;
        }
        .qrcode {
            width: 180px;
            height: 180px;
            margin: 0 auto;
        }
        /* 输入码区域 */
        .input-area {
            margin-bottom: 25px;
        }
        .input-area input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 3px;
        }
        .input-area input:focus {
            outline: none;
            border-color: #2196F3;
        }
        /* 按钮样式 */
        .btn-group {
            display: flex;
            gap: 10px;
        }
        button {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background: #1976D2;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* 文件拖放区域 */
        .drop-area {
            margin-top: 30px;
            padding: 30px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .drop-area.active {
            border-color: #2196F3;
            background: #f8fbff;
        }
        .drop-area p {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        #fileInput {
            display: none;
        }
        /* 传输列表 */
        .transfer-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-info {
            flex: 1;
            overflow: hidden;
        }
        .file-name {
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-size {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }
        .file-status {
            font-size: 12px;
            color: #2196F3;
        }
        /* 状态提示 */
        .status {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Yi互联</h1>
        </div>
        <div class="main">
            <!-- 连接码展示 -->
            <div class="code-area" style="display: none;">
                <div class="code-text" id="roomCode"></div>
                <div class="qrcode" id="qrcode"></div>
                <button class="btn-secondary" id="copyCodeBtn" style="margin-top: 10px; width: 100%;">复制连接码</button>
            </div>

            <!-- 输入连接码 -->
            <div class="input-area">
                <input type="text" id="joinCode" placeholder="输入对方连接码" maxlength="6">
            </div>

            <!-- 功能按钮 -->
            <div class="btn-group">
                <button class="btn-primary" id="createBtn">创建连接</button>
                <button class="btn-secondary" id="joinBtn">加入连接</button>
            </div>

            <!-- 文件拖放/选择 -->
            <div class="drop-area" id="dropArea" style="display: none;">
                <div>+ 点击或拖放文件到这里</div>
                <p>支持任意格式文件</p>
                <input type="file" id="fileInput" multiple>
            </div>

            <!-- 传输列表 -->
            <div class="transfer-list" id="transferList"></div>

            <!-- 状态提示 -->
            <div class="status" id="status">未建立连接</div>
        </div>
    </div>

    <script>
        // 核心变量
        let peerConnection;
        let dataChannel;
        let roomCode = '';
        // 存储局域网内的连接码映射（本地临时）
        const roomMap = {};
        const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // DOM 元素
        const codeArea = document.querySelector('.code-area');
        const roomCodeEl = document.getElementById('roomCode');
        const qrcodeEl = document.getElementById('qrcode');
        const joinCodeEl = document.getElementById('joinCode');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const transferList = document.getElementById('transferList');
        const statusEl = document.getElementById('status');
        const copyCodeBtn = document.getElementById('copyCodeBtn');

        // 生成6位随机连接码
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKMNPQRSTWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 创建连接
        createBtn.addEventListener('click', async () => {
            roomCode = generateRoomCode();
            roomMap[roomCode] = {};
            // 显示连接码和二维码
            codeArea.style.display = 'block';
            roomCodeEl.textContent = roomCode;
            QRCode.toCanvas(qrcodeEl, location.href + '?code=' + roomCode, (error) => {
                if (error) console.error(error);
            });
            // 初始化Peer
            initPeer(true);
            statusEl.textContent = '等待对方加入...';
            createBtn.disabled = true;
            joinBtn.disabled = true;
        });

        // 加入连接
        joinBtn.addEventListener('click', async () => {
            const code = joinCodeEl.value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                alert('请输入6位有效连接码');
                return;
            }
            roomCode = code;
            initPeer(false);
            statusEl.textContent = '正在加入连接...';
            createBtn.disabled = true;
            joinBtn.disabled = true;
        });

        // 初始化PeerConnection
        function initPeer(isInitiator) {
            peerConnection = new RTCPeerConnection(iceConfig);
            
            // 创建或监听数据通道
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('fileChannel');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (e) => {
                    dataChannel = e.channel;
                    setupDataChannel();
                };
            }

            // ICE候选处理
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) {
                    // 局域网内通过roomCode交换候选（简化版：本地临时存储）
                    if (!roomMap[roomCode].candidates) roomMap[roomCode].candidates = [];
                    roomMap[roomCode].candidates.push(e.candidate);
                    // 发起方创建Offer
                    if (isInitiator && !roomMap[roomCode].offer) {
                        createOffer();
                    }
                }
            };

            // 连接状态监听
            peerConnection.onconnectionstatechange = () => {
                switch (peerConnection.connectionState) {
                    case 'connected':
                        statusEl.textContent = '连接成功，可传输文件';
                        dropArea.style.display = 'block';
                        break;
                    case 'disconnected':
                        statusEl.textContent = '连接已断开';
                        resetState();
                        break;
                    case 'failed':
                        statusEl.textContent = '连接失败，请重试';
                        resetState();
                        break;
                }
            };
        }

        // 创建Offer
        async function createOffer() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            roomMap[roomCode].offer = offer;
        }

        // 处理Answer
        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // 配置数据通道
        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('数据通道已打开');
            };

            dataChannel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'file') {
                    receiveFile(data);
                }
            };

            dataChannel.onclose = () => {
                statusEl.textContent = '数据通道已关闭';
            };
        }

        // 接收文件
        function receiveFile(fileData) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${fileData.name}</div>
                    <div class="file-size">${formatSize(fileData.size)}</div>
                </div>
                <div class="file-status">已接收</div>
            `;
            transferList.appendChild(item);
            // 创建下载链接
            const a = document.createElement('a');
            a.href = fileData.data;
            a.download = fileData.name;
            a.click();
        }

        // 发送文件
        function sendFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileData = {
                    type: 'file',
                    name: file.name,
                    size: file.size,
                    data: e.target.result
                };
                dataChannel.send(JSON.stringify(fileData));
                // 添加到传输列表
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatSize(file.size)}</div>
                    </div>
                    <div class="file-status">已发送</div>
                `;
                transferList.appendChild(item);
            };
            reader.readAsDataURL(file);
        }

        // 文件拖放处理
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('active');
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('active');
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('active');
            if (e.dataTransfer.files.length) {
                Array.from(e.dataTransfer.files).forEach(sendFile);
            }
        });
        fileInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(sendFile);
        });

        // 复制连接码
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode).then(() => {
                alert('连接码已复制');
            });
        });

        // 格式化文件大小
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // 重置状态
        function resetState() {
            createBtn.disabled = false;
            joinBtn.disabled = false;
            dropArea.style.display = 'none';
            codeArea.style.display = 'none';
            transferList.innerHTML = '';
            roomCode = '';
        }

        // 页面加载时自动读取URL中的连接码
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                joinCodeEl.value = code;
                joinBtn.click();
            }
        };
    </script>
</body>
</html>